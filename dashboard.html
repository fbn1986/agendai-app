<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgendAI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      addDoc,
      query,
      onSnapshot,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_DOMINIO",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_BUCKET",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userId = "seuUserId"; // substitua conforme necessário

    function initializeAgenda(userId) {
      const addAppointmentBtn = document.getElementById('add-appointment-btn');
      const appointmentModal = document.getElementById('appointment-modal');

      const openAppointmentModal = () => {
        const modalContent = `
          <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800">
              <i data-feather="x" class="w-6 h-6"></i>
            </button>
            <h3 class="text-lg font-semibold text-slate-800 mb-4">Novo Agendamento</h3>
            <form id="appointment-form" class="space-y-4">
              <div>
                <label for="client-name" class="block text-sm font-medium text-slate-600">Nome do Cliente</label>
                <input type="text" id="client-name" required class="input-style">
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="appointment-service" class="block text-sm font-medium text-slate-600">Serviço</label>
                  <select id="appointment-service" required class="input-style"></select>
                </div>
                <div>
                  <label for="appointment-barber" class="block text-sm font-medium text-slate-600">Barbeiro</label>
                  <select id="appointment-barber" required class="input-style"></select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="appointment-date" class="block text-sm font-medium text-slate-600">Data</label>
                  <input type="date" id="appointment-date" required class="input-style">
                </div>
                <div>
                  <label for="appointment-time" class="block text-sm font-medium text-slate-600">Hora</label>
                  <select id="appointment-time" required class="input-style">
                    <option disabled selected>Selecione uma data primeiro</option>
                  </select>
                </div>
              </div>
              <button id="save-appointment-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center disabled:opacity-50">
                <span class="btn-text">Guardar Agendamento</span>
                <div class="spinner hidden ml-2"></div>
              </button>
            </form>
          </div>`;

        appointmentModal.innerHTML = modalContent;
        appointmentModal.classList.remove('hidden');
        appointmentModal.classList.add('flex');

        document.getElementById('close-modal-btn').addEventListener('click', () => {
          appointmentModal.innerHTML = '';
          appointmentModal.classList.add('hidden');
        });

        document.getElementById('appointment-form').addEventListener('submit', (e) => handleSaveAppointment(e, userId));

        populateSelectWithOptions(userId, 'services', 'appointment-service', 'Nenhum serviço');
        populateSelectWithOptions(userId, 'barbers', 'appointment-barber', 'Nenhum barbeiro');

        const dateInput = document.getElementById('appointment-date');
        dateInput.addEventListener('change', () => loadTimeOptions(userId, dateInput.value));

        feather.replace();
      };

      async function populateSelectWithOptions(userId, coll, selectId, emptyMsg) { 
        const selectEl = document.getElementById(selectId);
        onSnapshot(query(collection(db, 'users', userId, coll)), (snap) => {
          selectEl.innerHTML = '';
          if (snap.empty) {
            selectEl.innerHTML = `<option disabled selected>${emptyMsg}</option>`;
            return;
          }
          snap.forEach(doc => {
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.textContent = doc.data().name;
            selectEl.appendChild(opt);
          });
        });
      }

      function generateTimeSlots(startTime, endTime) {
        const slots = [];
        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);

        const startDate = new Date();
        startDate.setHours(startH, startM, 0, 0);
        const endDate = new Date();
        endDate.setHours(endH, endM, 0, 0);

        while (startDate < endDate) {
          const hours = startDate.getHours().toString().padStart(2, '0');
          const minutes = startDate.getMinutes().toString().padStart(2, '0');
          slots.push(`${hours}:${minutes}`);
          startDate.setMinutes(startDate.getMinutes() + 30);
        }

        return slots;
      }

      async function loadTimeOptions(userId, selectedDate) {
        const select = document.getElementById('appointment-time');
        select.innerHTML = `<option disabled selected>Carregando horários...</option>`;

        try {
          const ref = doc(db, 'users', userId, 'settings', 'workingHours');
          const snap = await getDoc(ref);
          if (!snap.exists()) {
            select.innerHTML = `<option disabled selected>Nenhum horário configurado</option>`;
            return;
          }

          const workingHours = snap.data();
          const date = new Date(selectedDate + 'T00:00:00');
          const weekday = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'][date.getDay()];
          const config = workingHours[weekday];

          if (!config || !config.isOpen) {
            select.innerHTML = `<option disabled selected>Sem horários disponíveis</option>`;
            return;
          }

          const slots = generateTimeSlots(config.start, config.end);
          select.innerHTML = '';
          slots.forEach(time => {
            const opt = document.createElement('option');
            opt.value = time;
            opt.textContent = time;
            select.appendChild(opt);
          });

        } catch (err) {
          console.error("Erro ao carregar horários:", err);
          select.innerHTML = `<option disabled selected>Erro ao carregar</option>`;
        }
      }

      async function handleSaveAppointment(e, userId) {
        e.preventDefault();
        const form = e.target;
        const saveBtn = form.querySelector('button[type="submit"]');
        saveBtn.disabled = true;

        try {
          const date = form.elements['appointment-date'].value;
          const time = form.elements['appointment-time'].value;
          const dateTime = Timestamp.fromDate(new Date(`${date}T${time}`));

          const serviceRef = doc(db, 'users', userId, 'services', form.elements['appointment-service'].value);
          const serviceSnap = await getDoc(serviceRef);
          const servicePrice = serviceSnap.exists() ? serviceSnap.data().price : 0;

          await addDoc(collection(db, 'users', userId, 'appointments'), {
            clientName: form.elements['client-name'].value,
            serviceId: form.elements['appointment-service'].value,
            serviceName: form.elements['appointment-service'].options[form.elements['appointment-service'].selectedIndex].text,
            barberName: form.elements['appointment-barber'].options[form.elements['appointment-barber'].selectedIndex].text,
            dateTime: dateTime,
            price: servicePrice,
            status: 'confirmado'
          });

          appointmentModal.innerHTML = '';
          appointmentModal.classList.add('hidden');

        } catch (err) {
          console.error("Erro ao guardar agendamento:", err);
        } finally {
          saveBtn.disabled = false;
        }
      }

      addAppointmentBtn.addEventListener('click', openAppointmentModal);
    }

    initializeAgenda(userId);
  </script>
</head>
<body class="bg-gray-100">
  <div class="p-6">
    <button id="add-appointment-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">
      Novo Agendamento
    </button>
  </div>
  <div id="appointment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center"></div>
</body>
</html>
