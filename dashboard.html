<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - AgendAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .spinner, .spinner-large { border-radius: 50%; animation: spin 1s ease-in-out infinite; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; width: 16px; height: 16px; }
        .spinner-large { border: 4px solid rgba(100, 116, 139, 0.2); border-top-color: #4f46e5; width: 50px; height: 50px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .calendar-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); grid-template-rows: auto; }
        .input-style { margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="loading-overlay" class="w-full h-screen flex flex-col items-center justify-center">
        <div class="spinner-large"></div>
        <p class="mt-4 text-slate-600">A verificar autenticação...</p>
    </div>

    <div id="app-container" class="hidden flex min-h-screen w-full">
        <aside id="sidebar" class="w-64 flex-shrink-0 bg-white border-r border-slate-200 flex-col hidden md:flex">
            <div class="h-16 flex items-center justify-center border-b border-slate-200">
                <h1 class="text-2xl font-bold text-gray-900 tracking-wider">Agend<span class="text-indigo-600">AI</span></h1>
            </div>
            <nav id="main-nav" class="flex-1 p-4 space-y-2">
                 <a href="#inicio" class="flex items-center px-4 py-2 text-sm font-semibold bg-indigo-50 text-indigo-700 rounded-lg"><i data-feather="home" class="w-5 h-5 mr-3"></i>Início</a>
                <a href="#agenda" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="calendar" class="w-5 h-5 mr-3"></i>Agenda</a>
                <a href="#clientes" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="users" class="w-5 h-5 mr-3"></i>Clientes</a>
                <a href="#servicos" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="tag" class="w-5 h-5 mr-3"></i>Serviços</a>
                <a href="#barbeiros" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="scissors" class="w-5 h-5 mr-3"></i>Barbeiros</a>
                <a href="#financeiro" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="dollar-sign" class="w-5 h-5 mr-3"></i>Financeiro</a>
                <a href="#configuracoes" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg"><i data-feather="settings" class="w-5 h-5 mr-3"></i>Configurações</a>
            </nav>
            <div class="p-4 border-t border-slate-200">
                <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-red-50 hover:text-red-600 rounded-lg"><i data-feather="log-out" class="w-5 h-5 mr-3"></i>Sair</button>
            </div>
        </aside>

        <div id="dashboard-content" class="flex-1 flex flex-col">
            <div id="trial-banner" class="hidden bg-yellow-100 border-b-2 border-yellow-200 text-center p-2 text-sm text-yellow-800"></div>
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 flex-shrink-0">
                 <div class="flex items-center">
                    <button id="menu-btn" class="md:hidden mr-4 text-slate-600"><i data-feather="menu" class="w-6 h-6"></i></button>
                    <h2 id="welcome-message" class="text-xl font-semibold text-slate-800">A carregar...</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-slate-500 hover:text-slate-800"><i data-feather="bell" class="w-6 h-6"></i></button>
                    <img id="user-avatar" src="https://placehold.co/40x40/e2e8f0/64748b?text=A" alt="Avatar do utilizador" class="w-10 h-10 rounded-full">
                </div>
            </header>

            <main id="main-content" class="flex-1 p-6 md:p-8 overflow-y-auto">
                </main>
        </div>
    </div>
    
    <div id="subscription-wall" class="hidden w-full h-screen flex-col items-center justify-center bg-slate-100 p-4 text-center"></div>
    <div id="access-denied-message" class="hidden w-full h-screen flex-col items-center justify-center p-4"></div>
    <div id="appointment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4"></div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, onSnapshot, query, collection, addDoc, getDocs, Timestamp, orderBy, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAkIUtakV64F2SYjvJylTGlw8-vTfXc3Fk",
        authDomain: "agendabarber-3fe30.firebaseapp.com",
        projectId: "agendabarber-3fe30",
        storageBucket: "agendabarber-3fe30.appspot.com",
        messagingSenderId: "1098037500040",
        appId: "1:1098037500040:web:62c82a203a3276ffaa273d"
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const loadingOverlay = document.getElementById('loading-overlay');
      const appContainer = document.getElementById('app-container');
      const subscriptionWall = document.getElementById('subscription-wall');
      const accessDeniedMessage = document.getElementById('access-denied-message');
      let revenueChartInstance = null;
      let servicesCache = new Map();
      let allClients = [];
      let currentWeekOffset = 0;

      onAuthStateChanged(auth, async (user) => {
          loadingOverlay.classList.add('hidden');
          if (user) {
              const userDocRef = doc(db, "users", user.uid);
              const userDocSnap = await getDoc(userDocRef);
              if (!userDocSnap.exists()) { showAccessDenied("Erro: Perfil não encontrado."); return; }
              const userData = userDocSnap.data();
              const createdAt = userData.createdAt?.toDate();
              if (!createdAt) { showAccessDenied("Erro: Data de criação da conta não encontrada."); return; }
              const trialEndDate = new Date(createdAt.getTime());
              trialEndDate.setDate(trialEndDate.getDate() + 14);
              const hasActiveSubscription = userData.subscription?.status === 'active';
              const isTrialActive = new Date() < trialEndDate;
              if (hasActiveSubscription || isTrialActive) {
                  const daysLeft = isTrialActive && !hasActiveSubscription ? Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                  showDashboard(user, userData, daysLeft);
              } else {
                  showSubscriptionWall();
              }
          } else {
              window.location.href = 'index.html';
          }
      });

      function showDashboard(user, userData, trialDaysLeft) {
          appContainer.classList.remove('hidden');
          appContainer.classList.add('flex');
          document.getElementById('welcome-message').textContent = `Bem-vindo, ${userData.barbershopName}!`;
          document.getElementById('user-avatar').src = `https://placehold.co/40x40/e2e8f0/64748b?text=${userData.barbershopName.charAt(0).toUpperCase()}`;
          const trialBanner = document.getElementById('trial-banner');
          if (trialDaysLeft !== null && trialDaysLeft >= 0) {
              trialBanner.textContent = `Você tem ${trialDaysLeft} dias restantes no seu período de teste.`;
              trialBanner.classList.remove('hidden');
          }
          initializeDashboard(user.uid);
          document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
      }

      function showSubscriptionWall() {
          subscriptionWall.classList.remove('hidden');
          subscriptionWall.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg max-w-md"><i data-feather="clock" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i><h1 class="text-2xl font-bold text-slate-800">O seu período de teste terminou</h1><p class="text-slate-600 mt-2 mb-6">Para continuar a gerir a sua barbearia, faça a sua assinatura.</p><div class="bg-indigo-50 border border-indigo-200 p-6 rounded-lg"><h3 class="font-bold text-indigo-800">Plano Mensal</h3><p class="text-4xl font-bold text-indigo-600 my-2">R$ 27,00<span class="text-lg font-normal text-slate-500">/mês</span></p><a href="https://buy.stripe.com/test_bJe14p8bLftHfq4grW5EY01" class="mt-6 block w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700">Assinar Agora</a></div><button id="logout-from-wall-btn" class="mt-4 text-sm text-slate-500 hover:text-slate-800">Sair da conta</button></div>`;
          document.getElementById('logout-from-wall-btn').addEventListener('click', () => signOut(auth));
          feather.replace();
      }

      function showAccessDenied(message) {
          accessDeniedMessage.classList.remove('hidden');
          accessDeniedMessage.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold">Acesso Negado</h1><p class="text-slate-600 mt-2">${message}</p><a href="index.html" class="mt-4 inline-block bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Ir para a Página Inicial</a></div>`;
      }
      
      function initializeDashboard(userId) {
          const mainContent = document.getElementById('main-content');
          mainContent.innerHTML = getDashboardHTML();
          setupNavigation(userId);
          feather.replace();
      }

      function setupNavigation(userId) {
          const mainNav = document.getElementById('main-nav');
          const initializedSections = new Set();
          const sections = {
            inicio: () => {},
            agenda: () => initializeAgenda(userId),
            clientes: () => initializeClients(userId),
            servicos: () => initializeServices(userId),
            barbeiros: () => initializeBarbers(userId),
            financeiro: () => initializeFinance(userId),
            configuracoes: () => setupSettings(userId),
          };
          mainNav.addEventListener('click', (e) => {
              const link = e.target.closest('a');
              if (link) {
                  e.preventDefault();
                  document.querySelectorAll('#main-nav a').forEach(l => l.classList.remove('bg-indigo-50', 'text-indigo-700'));
                  link.classList.add('bg-indigo-50', 'text-indigo-700');
                  const targetId = link.getAttribute('href').substring(1);
                  document.querySelectorAll('#main-content > div').forEach(section => section.classList.add('hidden'));
                  const targetSection = document.getElementById(`${targetId}-section`);
                  if (targetSection) {
                      targetSection.classList.remove('hidden');
                      if(sections[targetId] && !initializedSections.has(targetId)) {
                        sections[targetId]();
                        initializedSections.add(targetId);
                      }
                  }
              }
          });
          document.querySelector('#main-nav a[href="#inicio"]').click();
      }

      function getDashboardHTML() {
        return `
            <div id="inicio-section">
                <h2 class="text-2xl font-bold text-slate-800">Início</h2><p>Seja bem-vindo ao seu painel de controlo.</p>
            </div>
            <div id="agenda-section" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                         <button id="prev-week-btn" class="p-2 rounded-full hover:bg-slate-200"><i data-feather="chevron-left" class="w-5 h-5 text-slate-600"></i></button>
                         <h2 id="week-display" class="text-lg font-bold text-slate-800 text-center"></h2>
                         <button id="next-week-btn" class="p-2 rounded-full hover:bg-slate-200"><i data-feather="chevron-right" class="w-5 h-5 text-slate-600"></i></button>
                    </div>
                    <button id="add-appointment-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center w-full sm:w-auto justify-center"><i data-feather="plus" class="w-5 h-5 mr-2"></i>Novo Agendamento</button>
                </div>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden"><div id="calendar-grid" class="calendar-grid"></div></div>
            </div>
            <div id="clientes-section" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-slate-800">Meus Clientes</h2><div class="relative w-full sm:w-72"><i data-feather="search" class="absolute top-1/2 left-3 -translate-y-1/2 w-5 h-5 text-slate-400"></i><input type="text" id="client-search-input" placeholder="Procurar por nome..." class="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg"></div></div><div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th scope="col" class="px-6 py-3">Nome</th><th scope="col" class="px-6 py-3">Contacto</th><th scope="col" class="px-6 py-3">Última Visita</th><th scope="col" class="px-6 py-3">Total Gasto</th></tr></thead><tbody id="clients-table-body"></tbody></table></div></div>
            </div>
            <div id="servicos-section" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><section class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800 mb-4">Registar Novo Serviço</h3><form id="service-form" class="space-y-4"><div><label for="service-name" class="block text-sm font-medium">Nome</label><input type="text" id="service-name" required class="input-style"></div><div class="grid grid-cols-2 gap-4"><div><label for="service-duration" class="block text-sm font-medium">Duração (min)</label><input type="number" id="service-duration" required class="input-style"></div><div><label for="service-price" class="block text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" id="service-price" required class="input-style"></div></div><button id="save-service-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center disabled:opacity-50"><span class="btn-text">Guardar Serviço</span><div class="spinner hidden ml-2"></div></button></form></section><section class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800 mb-4">Os Meus Serviços</h3><div id="services-list" class="space-y-3 max-h-96 overflow-y-auto"></div></section></div>
            </div>
            <div id="barbeiros-section" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><section class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800 mb-4">Registar Novo Barbeiro</h3><form id="barber-form" class="space-y-4"><div><label for="barber-name" class="block text-sm font-medium">Nome</label><input type="text" id="barber-name" required class="input-style"></div><button id="save-barber-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center disabled:opacity-50"><span class="btn-text">Guardar Barbeiro</span><div class="spinner hidden ml-2"></div></button></form></section><section class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800 mb-4">Os Meus Barbeiros</h3><div id="barbers-list" class="space-y-3 max-h-96 overflow-y-auto"></div></section></div>
            </div>
            <div id="financeiro-section" class="hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Visão Financeira</h2><section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-slate-500">Faturação do Mês</p><p id="finance-month-revenue" class="text-3xl font-bold text-slate-800 mt-1">R$ 0,00</p></div><div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-slate-500">Faturação de Hoje</p><p id="finance-today-revenue" class="text-3xl font-bold text-slate-800 mt-1">R$ 0,00</p></div><div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-slate-500">Ticket Médio</p><p id="finance-avg-ticket" class="text-3xl font-bold text-slate-800 mt-1">R$ 0,00</p></div></section><section class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800 mb-4">Faturação (Últimos 7 dias)</h3><div><canvas id="revenue-chart"></canvas></div></section>
            </div>
            <div id="configuracoes-section" class="hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Configurações</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800">Horários de Funcionamento</h3><p class="text-sm text-slate-500 mt-1 mb-4">Defina os seus dias e horários de trabalho.</p><form id="working-hours-form" class="space-y-4"></form><button id="save-hours-btn" type="button" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center disabled:opacity-50"><span class="btn-text">Guardar Alterações</span><div class="spinner hidden ml-2"></div></button></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-800">O seu Link de Agendamento</h3><p class="text-sm text-slate-500 mt-1 mb-4">Partilhe este link no seu Instagram.</p><div class="flex items-center space-x-2"><input id="public-booking-link" type="text" readonly class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md"><button id="copy-link-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg flex-shrink-0">Copiar</button></div></div></div>
            </div>
        `;
      }
      
      // --- FUNÇÕES DE CADA SECÇÃO ---
      function initializeAgenda(userId) {
            const addAppointmentBtn = document.getElementById('add-appointment-btn');
            const appointmentModal = document.getElementById('appointment-modal');
            const calendarGrid = document.getElementById('calendar-grid');

            const openAppointmentModal = () => {
                appointmentModal.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full relative"><button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800"><i data-feather="x" class="w-6 h-6"></i></button><h3 class="text-lg font-semibold text-slate-800 mb-4">Novo Agendamento</h3><form id="appointment-form" class="space-y-4"><div><label for="client-name" class="block text-sm font-medium text-slate-600">Nome do Cliente</label><input type="text" id="client-name" required class="input-style"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="appointment-service" class="block text-sm font-medium text-slate-600">Serviço</label><select id="appointment-service" required class="input-style"></select></div><div><label for="appointment-barber" class="block text-sm font-medium text-slate-600">Barbeiro</label><select id="appointment-barber" required class="input-style"></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="appointment-date" class="block text-sm font-medium text-slate-600">Data</label><input type="date" id="appointment-date" required class="input-style"></div><div><label for="appointment-time" class="block text-sm font-medium text-slate-600">Hora</label><input type="time" id="appointment-time" required class="input-style"></div></div><button id="save-appointment-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center disabled:opacity-50"><span class="btn-text">Guardar Agendamento</span><div class="spinner hidden ml-2"></div></button></form></div>`;
                appointmentModal.classList.remove('hidden');
                appointmentModal.classList.add('flex');
                document.getElementById('close-modal-btn').addEventListener('click', closeAppointmentModal);
                document.getElementById('appointment-form').addEventListener('submit', (e) => handleSaveAppointment(e, userId));
                populateSelectWithOptions(userId, 'services', 'appointment-service', 'Nenhum serviço');
                populateSelectWithOptions(userId, 'barbers', 'appointment-barber', 'Nenhum barbeiro');
                feather.replace();
            };
            const closeAppointmentModal = () => {
                appointmentModal.innerHTML = '';
                appointmentModal.classList.add('hidden');
            };
            async function populateSelectWithOptions(userId, coll, selectId, emptyMsg) {
                const selectEl = document.getElementById(selectId);
                onSnapshot(query(collection(db, 'users', userId, coll)), (snap) => {
                    selectEl.innerHTML = '';
                    if (snap.empty) { selectEl.innerHTML = `<option disabled selected>${emptyMsg}</option>`; return; }
                    snap.forEach(doc => {
                        const opt = document.createElement('option');
                        opt.value = doc.id; 
                        opt.textContent = doc.data().name;
                        selectEl.appendChild(opt);
                    });
                });
            }
            async function handleSaveAppointment(e, userId) {
                e.preventDefault();
                const form = e.target;
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                try {
                    const date = form.elements['appointment-date'].value;
                    const time = form.elements['appointment-time'].value;
                    const dateTime = Timestamp.fromDate(new Date(`${date}T${time}`));
                    
                    const serviceRef = doc(db, 'users', userId, 'services', form.elements['appointment-service'].value);
                    const serviceSnap = await getDoc(serviceRef);
                    const servicePrice = serviceSnap.exists() ? serviceSnap.data().price : 0;
                    
                    await addDoc(collection(db, 'users', userId, 'appointments'), {
                        clientName: form.elements['client-name'].value,
                        serviceId: form.elements['appointment-service'].value,
                        serviceName: form.elements['appointment-service'].options[form.elements['appointment-service'].selectedIndex].text,
                        barberName: form.elements['appointment-barber'].options[form.elements['appointment-barber'].selectedIndex].text,
                        dateTime: dateTime,
                        price: servicePrice,
                        status: 'confirmado'
                    });
                    closeAppointmentModal();
                } catch(err) { console.error("Erro ao guardar agendamento:", err); }
                finally { saveBtn.disabled = false; }
            }
            function renderWeek(userId, offset = 0) {
              const today = new Date();
              today.setDate(today.getDate() + offset * 7);
              const dayOfWeek = today.getDay();
              const weekStart = new Date(today.setDate(today.getDate() - dayOfWeek));
              const weekEnd = new Date(new Date(weekStart).setDate(weekStart.getDate() + 6));
              
              document.getElementById('week-display').textContent = `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
              
              calendarGrid.innerHTML = ''; // Limpa a grelha
              
              const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
              calendarGrid.innerHTML += `<div class="time-column"></div>` + days.map(d => `<div class="text-center font-bold p-2 border-b">${d}</div>`).join('');
              
              for(let i = 7; i < 22; i++) { // Horas das 7h às 21h
                calendarGrid.innerHTML += `<div class="text-center text-xs p-1 border-r">${i}:00</div>` + days.map(() => `<div class="day-slot border-r border-b p-1"></div>`).join('');
              }

              const startTimestamp = Timestamp.fromDate(weekStart);
              const endTimestamp = Timestamp.fromDate(new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate(), 23, 59, 59));
              
              const q = query(collection(db, 'users', userId, 'appointments'), where("dateTime", ">=", startTimestamp), where("dateTime", "<=", endTimestamp));

              onSnapshot(q, (snapshot) => {
                  snapshot.forEach(doc => {
                      const app = doc.data();
                      const appDate = app.dateTime.toDate();
                      const dayIndex = appDate.getDay();
                      const hourIndex = appDate.getHours();
                      
                      const slotIndex = (hourIndex - 7) * 8 + (dayIndex + 1);
                      const targetSlot = calendarGrid.children[slotIndex];

                      if (targetSlot) {
                         const appEl = document.createElement('div');
                         appEl.className = 'bg-indigo-100 p-1 rounded text-xs';
                         appEl.innerHTML = `<strong>${app.clientName}</strong><br>${app.serviceName}`;
                         targetSlot.appendChild(appEl);
                      }
                  });
              });
            }
            
            document.getElementById('prev-week-btn').addEventListener('click', () => { currentWeekOffset--; renderWeek(userId, currentWeekOffset); });
            document.getElementById('next-week-btn').addEventListener('click', () => { currentWeekOffset++; renderWeek(userId, currentWeekOffset); });

            addAppointmentBtn.addEventListener('click', openAppointmentModal);
            renderWeek(userId); // Renderiza a semana atual ao iniciar
      }
      function initializeClients(userId) { /* ... */ }
      function initializeServices(userId) {
        const form = document.getElementById('service-form');
        const listDiv = document.getElementById('services-list');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.disabled = true;
            try {
                await addDoc(collection(db, 'users', userId, 'services'), {
                    name: form.elements['service-name'].value,
                    duration: Number(form.elements['service-duration'].value),
                    price: Number(form.elements['service-price'].value)
                });
                form.reset();
            } catch (error) { console.error("Erro ao guardar serviço:", error); } 
            finally { saveBtn.disabled = false; }
        });
        onSnapshot(query(collection(db, 'users', userId, 'services')), (snap) => {
            servicesCache.clear();
            listDiv.innerHTML = snap.empty ? '<p>Nenhum serviço.</p>' : '';
            snap.forEach(doc => {
                const service = { id: doc.id, ...doc.data() };
                servicesCache.set(service.id, service);
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-lg';
                el.innerHTML = `<div><p class="font-semibold">${service.name}</p><p class="text-sm text-slate-500">${service.duration} min - R$ ${service.price.toFixed(2)}</p></div><button class="text-slate-400 hover:text-red-600"><i data-feather="trash-2" class="w-4 h-4"></i></button>`;
                listDiv.appendChild(el);
            });
            feather.replace();
        });
      }
      function initializeBarbers(userId) {
        const form = document.getElementById('barber-form');
        const listDiv = document.getElementById('barbers-list');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.disabled = true;
            try {
                await addDoc(collection(db, 'users', userId, 'barbers'), { name: form.elements['barber-name'].value });
                form.reset();
            } catch (error) { console.error("Erro ao guardar barbeiro:", error); }
            finally { saveBtn.disabled = false; }
        });
        onSnapshot(query(collection(db, 'users', userId, 'barbers')), (snap) => {
            listDiv.innerHTML = snap.empty ? '<p>Nenhum barbeiro.</p>' : '';
            snap.forEach(doc => {
                const barber = { id: doc.id, ...doc.data() };
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-lg';
                el.innerHTML = `<p class="font-semibold">${barber.name}</p><button class="text-slate-400 hover:text-red-600"><i data-feather="trash-2" class="w-4 h-4"></i></button>`;
                listDiv.appendChild(el);
            });
            feather.replace();
        });
      }
      function initializeFinance(userId) {
        onSnapshot(query(collection(db, 'users', userId, 'appointments')), (snap) => {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let todayRevenue = 0;
            let monthRevenue = 0;
            let totalAppointments = 0;
            const last7Days = Array(7).fill(0);

            snap.forEach(doc => {
                const app = doc.data();
                const appDate = app.dateTime.toDate();
                const price = app.price || 0;

                totalAppointments++;
                if (appDate >= monthStart) monthRevenue += price;
                if (appDate >= todayStart) todayRevenue += price;

                const diffDays = Math.floor((now - appDate) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays < 7) {
                    last7Days[diffDays] += price;
                }
            });
            
            document.getElementById('finance-today-revenue').textContent = `R$ ${todayRevenue.toFixed(2)}`;
            document.getElementById('finance-month-revenue').textContent = `R$ ${monthRevenue.toFixed(2)}`;
            document.getElementById('finance-avg-ticket').textContent = `R$ ${(monthRevenue / totalAppointments || 0).toFixed(2)}`;
            
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            if (revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 7}, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        return d.toLocaleDateString('pt-BR', { weekday: 'short' });
                    }).reverse(),
                    datasets: [{
                        label: 'Faturação',
                        data: last7Days.reverse(),
                        borderColor: '#4f46e5',
                        tension: 0.1
                    }]
                }
            });
        });
      }
      function setupSettings(userId) {
        const form = document.getElementById('working-hours-form');
        const saveBtn = document.getElementById('save-hours-btn');
        async function loadHours() {
            const ref = doc(db, 'users', userId, 'settings', 'workingHours');
            const docSnap = await getDoc(ref);
            const hoursData = docSnap.exists() ? docSnap.data() : {};
            const days = [ { id: 'dom', name: 'Domingo' }, { id: 'seg', name: 'Segunda' }, { id: 'ter', name: 'Terça' }, { id: 'qua', name: 'Quarta' }, { id: 'qui', name: 'Quinta' }, { id: 'sex', name: 'Sexta' }, { id: 'sab', name: 'Sábado' }];
            form.innerHTML = '';
            days.forEach(day => {
                const dayData = hoursData[day.id] || { isOpen: day.id !== 'dom', start: '09:00', end: '18:00' };
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between border-t pt-3';
                row.innerHTML = `<span class="font-medium">${day.name}</span><div class="flex items-center gap-4"><div class="flex items-center gap-2"><input type="time" id="${day.id}-start" value="${dayData.start}" class="p-1 border rounded-md text-sm" ${!dayData.isOpen ? 'disabled' : ''}><span>às</span><input type="time" id="${day.id}-end" value="${dayData.end}" class="p-1 border rounded-md text-sm" ${!dayData.isOpen ? 'disabled' : ''}></div><div class="relative inline-block w-10 align-middle"><input type="checkbox" id="${day.id}-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${dayData.isOpen ? 'checked' : ''} /><label for="${day.id}-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div>`;
                form.appendChild(row);
                row.querySelector(`#${day.id}-toggle`).addEventListener('change', (e) => {
                    row.querySelectorAll('input[type="time"]').forEach(input => input.disabled = !e.target.checked);
                });
            });
        }
        async function saveHours() {
            saveBtn.disabled = true;
            const dataToSave = {};
            ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'].forEach(id => {
                dataToSave[id] = {
                    isOpen: document.getElementById(`${id}-toggle`).checked,
                    start: document.getElementById(`${id}-start`).value,
                    end: document.getElementById(`${id}-end`).value,
                };
            });
            try {
                await setDoc(doc(db, 'users', userId, 'settings', 'workingHours'), dataToSave);
            } catch(e) { console.error(e); }
            finally { saveBtn.disabled = false; }
        }
        document.getElementById('copy-link-btn').addEventListener('click', () => {
            const input = document.getElementById('public-booking-link');
            input.value = `${window.location.origin}/booking.html?user=${userId}`;
            input.select();
            document.execCommand('copy');
        });
        loadHours();
        saveBtn.addEventListener('click', saveHours);
      }

    </script>
</body>
</html>
