<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - AgendaUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .input-style { 
            margin-top: 0.25rem; 
            display: block; 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.375rem; 
            background-color: #f8fafc;
        }
        .time-slot:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }
        .time-slot.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head><body class="flex justify-center items-start min-h-screen p-4 sm:p-6 md:p-8 bg-slate-50">

    <div id="main-container" class="w-full max-w-lg mx-auto hidden">
        <header class="text-center mb-8">
            <img id="barbershop-logo" src="https://i.postimg.cc/ZKq9v4Xh/Flux-Dev-Design-a-clean-professional-logo-for-a-scheduling-pla-2.jpg" alt="Logo da Barbearia" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-white shadow-lg">
            <h1 id="barbershop-name" class="text-2xl sm:text-3xl font-bold text-slate-800">Carregando...</h1>
            <p class="text-slate-500 mt-1">Faça seu agendamento online</p>
        </header>

        <main id="booking-main" class="bg-white p-6 sm:p-8 rounded-lg shadow-xl">
            <h2 class="text-xl font-bold text-slate-900 mb-6 text-center">Novo Agendamento</h2>
            <form id="booking-form" class="space-y-5">
                
                <div>
                    <label for="client-name" class="block text-sm font-medium text-slate-700">Nome</label>
                    <input type="text" id="client-name" required class="input-style" placeholder="Seu nome completo">
                </div>
                
                <div>
                    <label for="client-phone" class="block text-sm font-medium text-slate-700">Telefone</label>
                    <input type="tel" id="client-phone" required class="input-style" placeholder="(XX) XXXXX-XXXX">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="booking-date" class="block text-sm font-medium text-slate-700">Data</label>
                        <input type="date" id="booking-date" required class="input-style">
                    </div>
                    <div>
                        <label for="time-select" class="block text-sm font-medium text-slate-700">Hora de Início</label>
                        <select id="time-select" required class="input-style bg-white">
                            <option value="">--:--</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700">Serviços</label>
                    <div id="services-container" class="space-y-2 mt-1">
                        </div>
                    <button type="button" id="add-service-btn" class="mt-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center">
                        <i data-feather="plus" class="w-4 h-4 mr-1"></i>Adicionar outro serviço
                    </button>
                </div>
                
                <div class="pt-4 border-t">
                    <p class="text-right font-bold text-lg text-slate-800">Valor Total: <span id="total-price" class="text-indigo-600">R$ 0,00</span></p>
                </div>
                
                <div class="flex items-center gap-4 pt-4">
                    <button id="cancel-btn" type="button" class="w-full text-center text-slate-600 font-semibold py-3 px-4 rounded-lg hover:bg-slate-100">Cancelar</button>
                    <button id="confirm-booking-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50" disabled>
                        Salvar Agendamento
                    </button>
                </div>
            </form>
        </main>
    </div>
    
    <div id="error-container" class="hidden text-center p-4">
        <h1 class="text-2xl font-bold text-red-600">Link de Agendamento Inválido</h1>
        <p class="text-slate-600 mt-2">Não foi possível encontrar o estabelecimento.</p>
    </div><div id="confirmation-view" class="hidden w-full max-w-lg mx-auto bg-white p-8 rounded-lg shadow-xl text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-feather="check" class="w-10 h-10 text-green-600"></i>
        </div>
        <h2 class="font-bold text-xl text-slate-800">Agendamento Confirmado!</h2>
        <p class="text-slate-600 mt-2">Seus horários foram reservados com sucesso.</p>
        <div id="confirmation-summary" class="bg-slate-50 p-4 rounded-lg mt-6 text-sm text-left space-y-1"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, where, Timestamp, getDocs, increment, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAkIUtakV64F2SYjvJylTGlw8-vTfXc3Fk",
            authDomain: "agendabarber-3fe30.firebaseapp.com",
            projectId: "agendabarber-3fe30",
            storageBucket: "agendabarber-3fe30.appspot.com",
            messagingSenderId: "1098037500040",
            appId: "1:1098037500040:web:62c82a203a3276ffaa273d"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const urlParams = new URLSearchParams(window.location.search);
        const OWNER_ID = urlParams.get('user');
        
        const state = { 
            selectedServices: [],
            selectedDate: null, 
            selectedTime: null,
            allServices: [],
            selectedBarber: null
        };

        async function loadInitialData() { 
            if (!OWNER_ID) { 
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('error-container').classList.remove('hidden'); 
                return; 
            } 
            try { 
                const userRef = doc(db, "users", OWNER_ID);
                const servicesQuery = query(collection(db, "users", OWNER_ID, "services"));
                const barbersQuery = query(collection(db, "users", OWNER_ID, "barbers"));
                
                const [userSnap, servicesSnap, barbersSnap] = await Promise.all([getDoc(userRef), getDocs(servicesQuery), getDocs(barbersQuery)]);

                if (userSnap.exists()) { 
                    document.getElementById('barbershop-name').textContent = userSnap.data().barbershopName || "Salão"; 
                    state.allServices = servicesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (barbersSnap.docs.length > 0) {
                        state.selectedBarber = { id: barbersSnap.docs[0].id, ...barbersSnap.docs[0].data() };
                    }

                    document.getElementById('main-container').classList.remove('hidden'); 
                    setupEventListeners();
                    addServiceDropdown(); // Adiciona o primeiro dropdown de serviço
                } else { 
                    document.getElementById('error-container').classList.remove('hidden'); 
                } 
            } catch (error) { 
                console.error("Erro ao carregar informações:", error); 
                document.getElementById('error-container').classList.remove('hidden'); 
            } 
        }function addServiceDropdown() {
            const container = document.getElementById('services-container');
            const newIndex = container.children.length;

            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'flex items-center gap-2';
            
            const select = document.createElement('select');
            select.className = 'input-style bg-white flex-grow service-select';
            select.dataset.index = newIndex;
            select.innerHTML = '<option value="">Selecione um serviço</option>';
            state.allServices.forEach(service => {
                const option = document.createElement('option');
                option.value = JSON.stringify(service);
                option.textContent = `${service.name} (R$ ${service.price.toFixed(2)})`;
                select.appendChild(option);
            });
            serviceDiv.appendChild(select);
            
            if (newIndex > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '<i data-feather="trash-2" class="w-5 h-5 text-red-500"></i>';
                removeBtn.onclick = () => {
                    serviceDiv.remove();
                    updateTotalPriceAndSlots();
                    feather.replace();
                };
                serviceDiv.appendChild(removeBtn);
            }

            container.appendChild(serviceDiv);
            feather.replace();

            select.addEventListener('change', updateTotalPriceAndSlots);
        }

        function updateTotalPriceAndSlots() {
            let totalPrice = 0;
            const serviceDropdowns = document.querySelectorAll('.service-select');
            state.selectedServices = [];

            serviceDropdowns.forEach(select => {
                if (select.value) {
                    const service = JSON.parse(select.value);
                    totalPrice += service.price;
                    state.selectedServices.push(service);
                }
            });

            document.getElementById('total-price').textContent = `R$ ${totalPrice.toFixed(2)}`;

            if (state.selectedDate && state.selectedServices.length > 0) {
                loadAvailableTimes(state.selectedDate);
            }
        }

        async function loadAvailableTimes(dateStr) {
            const timeSelect = document.getElementById('time-select');
            timeSelect.innerHTML = '<option value="">Carregando...</option>';
            timeSelect.disabled = true;

            try {
                const settingsRef = doc(db, 'users', OWNER_ID, 'settings', 'workingHours');
                const settingsSnap = await getDoc(settingsRef);
                const workingHours = settingsSnap.exists() ? settingsSnap.data() : {};
                
                const selectedDate = new Date(`${dateStr}T12:00:00Z`);
                const dayOfWeek = selectedDate.getUTCDay();
                const dayKeys = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
                const daySettings = workingHours[dayKeys[dayOfWeek]];

                if (!daySettings || !daySettings.isOpen) {
                    timeSelect.innerHTML = '<option value="">Fechado neste dia</option>';
                    return;
                }

                const allPossibleSlots = [];
                let currentHour = parseInt(daySettings.start.split(':')[0]);
                let currentMinute = parseInt(daySettings.start.split(':')[1]);
                let endHour = parseInt(daySettings.end.split(':')[0]);
                let endMinute = parseInt(daySettings.end.split(':')[1]);

                while (currentHour < endHour || (currentHour === endHour && currentMinute < endMinute)) {
                    allPossibleSlots.push(`${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`);
                    currentMinute += 30;
                    if (currentMinute >= 60) {
                        currentHour++;
                        currentMinute -= 60;
                    }
                }
                
                const startOfDay = Timestamp.fromDate(new Date(`${dateStr}T00:00:00Z`));
                const endOfDay = Timestamp.fromDate(new Date(`${dateStr}T23:59:59Z`));
                const appointmentsQuery = query(collection(db, "users", OWNER_ID, "appointments"), where('dateTime', '>=', startOfDay), where('dateTime', '<=', endOfDay));
                const querySnapshot = await getDocs(appointmentsQuery);
                const bookedTimes = new Set(querySnapshot.docs.map(doc => {
                    const date = doc.data().dateTime.toDate();
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                }));

                const now = new Date();
                const isToday = now.toISOString().split('T')[0] === dateStr;

                timeSelect.innerHTML = '<option value="">Selecione um horário</option>';
                let availableCount = 0;
                allPossibleSlots.forEach(time => {
                    const numServices = state.selectedServices.length;
                    let canBook = true;
                    for (let i = 0; i < numServices; i++) {
                        const tempDate = new Date(`${dateStr}T${time}:00`);
                        tempDate.setMinutes(tempDate.getMinutes() + (i * 30));
                        const checkTime = `${String(tempDate.getHours()).padStart(2, '0')}:${String(tempDate.getMinutes()).padStart(2, '0')}`;
                        if (bookedTimes.has(checkTime) || (isToday && tempDate < now)) {
                            canBook = false;
                            break;
                        }
                    }

                    if (canBook) {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        timeSelect.appendChild(option);
                        availableCount++;
                    }
                });

                if (availableCount === 0) {
                    timeSelect.innerHTML = '<option value="">Sem horários livres</option>';
                } else {
                    timeSelect.disabled = false;
                }
            } catch (error) {
                console.error("Erro ao carregar horários:", error);
                timeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }const findOrCreateClient = async (userId, clientName, clientPhone) => {
            const clientsRef = collection(db, 'users', userId, 'clients');
            const q = query(clientsRef, where("phone", "==", clientPhone));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                return querySnapshot.docs[0].id;
            } else {
                const newClientRef = await addDoc(clientsRef, {
                    name: clientName,
                    phone: clientPhone,
                    createdAt: Timestamp.now(),
                    appointmentCount: 0
                });
                return newClientRef.id;
            }
        };

        async function handleConfirmBooking(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('confirm-booking-btn');
            btn.disabled = true;
            btn.innerHTML = 'Confirmando...';

            try {
                const clientName = form.elements['client-name'].value;
                const clientPhone = form.elements['client-phone'].value;
                const clientId = await findOrCreateClient(OWNER_ID, clientName, clientPhone);
                
                const batch = writeBatch(db);
                const firstAppointmentDate = new Date(`${state.selectedDate}T${state.selectedTime}:00`);

                for (let i = 0; i < state.selectedServices.length; i++) {
                    const service = state.selectedServices[i];
                    const appointmentDate = new Date(firstAppointmentDate.getTime() + (i * 30 * 60000));
                    
                    const newAppointmentRef = doc(collection(db, "users", OWNER_ID, "appointments"));

                    batch.set(newAppointmentRef, {
                        clientName, clientPhone, clientId,
                        serviceId: service.id,
                        serviceName: service.name,
                        barberId: state.selectedBarber.id,
                        barberName: state.selectedBarber.name,
                        dateTime: Timestamp.fromDate(appointmentDate),
                        price: service.price,
                        status: 'confirmado',
                        createdAt: Timestamp.now()
                    });
                }
                
                await batch.commit();

                const clientRef = doc(db, 'users', OWNER_ID, 'clients', clientId);
                await updateDoc(clientRef, { 
                    appointmentCount: increment(state.selectedServices.length),
                    lastAppointmentDate: Timestamp.fromDate(firstAppointmentDate)
                });

                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('confirmation-view').classList.remove('hidden');
                
                let serviceListHTML = state.selectedServices.map(s => `<p><strong>Serviço:</strong> ${s.name}</p>`).join('');
                let totalPrice = state.selectedServices.reduce((acc, s) => acc + s.price, 0);
                
                document.getElementById('confirmation-summary').innerHTML = `
                    <p><strong>Nome:</strong> ${clientName}</p>
                    ${serviceListHTML}
                    <p><strong>Data:</strong> ${firstAppointmentDate.toLocaleDateString('pt-BR')} a partir das ${state.selectedTime}</p>
                    <p class="font-bold"><strong>Total:</strong> R$ ${totalPrice.toFixed(2)}</p>
                `;
                feather.replace();

            } catch (error) {
                console.error("Erro ao confirmar agendamento: ", error);
                alert("Não foi possível confirmar o agendamento. Tente novamente.");
                btn.disabled = false;
                btn.innerHTML = 'Salvar Agendamento';
            }
        }function setupEventListeners() {
            const dateInput = document.getElementById('booking-date');
            const timeSelect = document.getElementById('time-select');
            const confirmBtn = document.getElementById('confirm-booking-btn');

            document.getElementById('add-service-btn').addEventListener('click', addServiceDropdown);
            
            dateInput.setAttribute('min', new Date().toISOString().split('T')[0]);

            dateInput.addEventListener('change', (e) => {
                state.selectedDate = e.target.value;
                state.selectedTime = null;
                timeSelect.innerHTML = '<option value="">--:--</option>';
                confirmBtn.disabled = true;
                if (state.selectedServices.length > 0) {
                    loadAvailableTimes(state.selectedDate);
                } else {
                    alert("Por favor, selecione pelo menos um serviço primeiro.");
                    dateInput.value = '';
                }
            });
            
            timeSelect.addEventListener('change', (e) => {
                state.selectedTime = e.target.value;
                confirmBtn.disabled = !state.selectedTime;
            });
            
            document.getElementById('booking-form').addEventListener('submit', handleConfirmBooking);
            
            document.getElementById('cancel-btn').addEventListener('click', () => {
                if (confirm("Tem certeza que deseja limpar o formulário?")) {
                    document.getElementById('booking-form').reset();
                    document.getElementById('total-price').textContent = 'R$ 0,00';
                    document.getElementById('services-container').innerHTML = '';
                    addServiceDropdown();
                    timeSelect.innerHTML = '<option value="">--:--</option>';
                    confirmBtn.disabled = true;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            feather.replace(); 
        });
    </script>
</body>
</html>
