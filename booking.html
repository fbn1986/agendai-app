<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - AgendAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        :root {
            --cor-primaria: #4f46e5;
            --cor-primaria-fundo: #eef2ff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--cor-primaria-fundo, #f8fafc);
            transition: background-color 0.3s ease;
        }
        .time-slot:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }
        .time-slot.selected {
            background-color: var(--cor-primaria, #4f46e5);
            color: white;
            border-color: var(--cor-primaria, #4f46e5);
        }
        .hover\:border-primario:hover { border-color: var(--cor-primaria, #4f46e5); }
        .hover\:bg-primario-fundo:hover { background-color: var(--cor-primaria-fundo, #eef2ff); }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-6 md:p-8">

    <div id="main-container" class="w-full max-w-2xl mx-auto hidden">
        <header class="text-center mb-8">
            <img id="barbershop-logo" src="https://i.postimg.cc/nrzVXpLP/Untitled-design.png" alt="Logo da Empresa" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover">
            <h1 id="barbershop-name" class="text-2xl sm:text-3xl font-bold text-slate-800">Carregando...</h1>
            <p class="text-slate-500 mt-1">Faça seu agendamento online</p>
        </header>

        <main class="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-md space-y-8">
            
            <div id="step-1-service">
                <h2 class="font-semibold text-lg text-slate-700 mb-4">1. Escolha o serviço</h2>
                <select id="service-select" class="w-full p-3 border border-slate-300 rounded-md bg-white">
                    <option value="">Carregando serviços...</option>
                </select>
            </div>
            
            <div id="step-2-datetime" class="hidden">
                <h2 class="font-semibold text-lg text-slate-700 mb-4">2. Escolha a data e o horário</h2>
                <div>
                    <label for="booking-date" class="block text-sm font-medium text-slate-600 mb-2">Selecione o dia:</label>
                    <input type="date" id="booking-date" class="w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div id="time-slots-container" class="mt-4">
                    <p class="text-slate-500 text-sm">Selecione uma data para ver os horários disponíveis.</p>
                </div>
                <button id="back-to-step-1" class="mt-4 text-sm text-slate-500 hover:text-slate-800">&larr; Voltar para serviços</button>
            </div>

            <div id="step-3-userinfo" class="hidden">
                <h2 class="font-semibold text-lg text-slate-700 mb-4">3. Suas informações</h2>
                <div id="summary" class="bg-slate-50 p-4 rounded-lg mb-4 text-sm space-y-1"></div>
                <form id="client-info-form">
                    <div class="space-y-4">
                        <div>
                            <label for="public-client-name" class="block text-sm font-medium text-slate-600">Seu nome</label>
                            <input type="text" id="public-client-name" placeholder="Digite seu nome completo" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                        </div>
                        <div>
                            <label for="public-client-phone" class="block text-sm font-medium text-slate-600">Seu WhatsApp</label>
                            <input type="tel" id="public-client-phone" placeholder="(XX) XXXXX-XXXX" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col items-center">
                        <button id="confirm-booking-btn" type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:opacity-50">Confirmar Agendamento</button>
                        <button id="back-to-step-2" type="button" class="mt-4 text-sm text-slate-500 hover:text-slate-800">&larr; Voltar para data/hora</button>
                    </div>
                </form>
            </div>

            <div id="step-4-confirmation" class="hidden text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="check" class="w-10 h-10 text-green-600"></i>
                </div>
                <h2 class="font-bold text-xl text-slate-800">Agendamento Confirmado!</h2>
                <p class="text-slate-600 mt-2">Seu horário foi reservado com sucesso.</p>
                <div id="confirmation-summary" class="bg-slate-50 p-4 rounded-lg mt-6 text-sm text-left space-y-1"></div>
            </div>
        </main>
    </div>
    
    <div id="error-container" class="hidden text-center p-4">
        <h1 class="text-2xl font-bold text-red-600">Link de Agendamento Inválido</h1>
        <p class="text-slate-600 mt-2">Não foi possível encontrar o estabelecimento. Por favor, verifique o link ou entre em contato.</p>
    </div><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, where, Timestamp, getDocs, increment, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAkIUtakV64F2SYjvJylTGlw8-vTfXc3Fk",
            authDomain: "agendabarber-3fe30.firebaseapp.com",
            projectId: "agendabarber-3fe30",
            storageBucket: "agendabarber-3fe30.appspot.com",
            messagingSenderId: "1098037500040",
            appId: "1:1098037500040:web:62c82a203a3276ffaa273d"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const urlParams = new URLSearchParams(window.location.search);
        const OWNER_ID = urlParams.get('user');
        
        const state = { 
            selectedService: null, 
            selectedDate: null, 
            selectedTime: null,
            services: []
        };
        
        const steps = { 
            service: document.getElementById('step-1-service'), 
            datetime: document.getElementById('step-2-datetime'), 
            userinfo: document.getElementById('step-3-userinfo'), 
            confirmation: document.getElementById('step-4-confirmation') 
        };

        const applyTheme = (themeData) => {
            const themes = {
                indigo: { 'cor-primaria': '#4f46e5', 'cor-primaria-fundo': '#eef2ff' },
                rose:   { 'cor-primaria': '#e11d48', 'cor-primaria-fundo': '#fff1f2' },
                emerald:{ 'cor-primaria': '#059669', 'cor-primaria-fundo': '#ecfdf5' },
                slate:  { 'cor-primaria': '#475569', 'cor-primaria-fundo': '#f1f5f9' }
            };
            const theme = themes[themeData] || themes.indigo;
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(`--${key}`, value);
            }
        };

        function showStep(stepName) { 
            Object.values(steps).forEach(step => step.classList.add('hidden')); 
            if (steps[stepName]) { steps[stepName].classList.remove('hidden'); } 
        }

        async function loadInitialData() { 
            if (!OWNER_ID) { 
                document.getElementById('error-container').classList.remove('hidden'); 
                return; 
            } 
            try {
                const userRef = doc(db, "users", OWNER_ID);
                const settingsRef = doc(db, "users", OWNER_ID, "settings", "app");
                const [userSnap, settingsSnap] = await Promise.all([getDoc(userRef), getDoc(settingsRef)]);
                
                if (userSnap.exists()) { 
                    const userData = userSnap.data();
                    document.getElementById('barbershop-name').textContent = userData.barbershopName || "Meu Negócio";
                    if (userData.logoUrl) {
                        document.getElementById('barbershop-logo').src = userData.logoUrl;
                    }
                    if (settingsSnap.exists()) {
                        applyTheme(settingsSnap.data().theme);
                    }
                    document.getElementById('main-container').classList.remove('hidden'); 
                    await loadServices();
                    setupEventListeners();
                } else { 
                    document.getElementById('error-container').classList.remove('hidden'); 
                } 
            } catch (error) { 
                console.error("Erro ao carregar informações:", error); 
                document.getElementById('error-container').classList.remove('hidden'); 
            } 
        }

        async function loadServices() { 
            const select = document.getElementById('service-select');
            select.innerHTML = '<option value="">Carregando serviços...</option>';
            try {
                const q = query(collection(db, "users", OWNER_ID, "services"));
                const querySnapshot = await getDocs(q);
                
                state.services = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

                select.innerHTML = '<option value="">Selecione um serviço</option>';
                if (state.services.length === 0) { 
                    select.innerHTML = '<option value="">Nenhum serviço disponível</option>';
                    return; 
                }
                state.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} (${service.duration} min) - R$ ${service.price.toFixed(2)}`;
                    select.appendChild(option);
                });
            } catch (error) { 
                console.error("Erro ao carregar serviços:", error); 
                select.innerHTML = '<option value="">Erro ao carregar serviços</option>'; 
            } 
        }async function loadAvailableTimes(dateStr) {
            const timeSlotsContainer = document.getElementById('time-slots-container');
            timeSlotsContainer.innerHTML = '<p class="text-slate-500 text-sm text-center">Verificando horários...</p>';

            if (!state.selectedService) {
                timeSlotsContainer.innerHTML = '<p class="text-red-500 text-sm">Erro: Nenhum serviço selecionado.</p>';
                return;
            }

            try {
                const settingsRef = doc(db, 'users', OWNER_ID, 'settings', 'workingHours');
                const settingsSnap = await getDoc(settingsRef);
                const workingHours = settingsSnap.exists() ? settingsSnap.data() : {};

                const selectedDate = new Date(`${dateStr}T12:00:00Z`); // Usar UTC para evitar problemas de fuso
                const dayOfWeek = selectedDate.getUTCDay();
                const dayKeys = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
                const daySettings = workingHours[dayKeys[dayOfWeek]];

                if (!daySettings || !daySettings.isOpen) {
                    timeSlotsContainer.innerHTML = '<p class="text-slate-500 text-sm text-center mt-4">Fechado neste dia.</p>';
                    return;
                }

                const serviceDuration = state.selectedService.duration;
                const allPossibleSlots = [];
                const startTime = new Date(`${dateStr}T${daySettings.start}:00`);
                const endTime = new Date(`${dateStr}T${daySettings.end}:00`);
                let currentTime = startTime;

                // Gera slots de verificação a cada 15 minutos para maior precisão
                while (new Date(currentTime.getTime() + serviceDuration * 60000) <= endTime) {
                    allPossibleSlots.push(new Date(currentTime));
                    currentTime.setMinutes(currentTime.getMinutes() + 15);
                }
                
                const startOfDay = Timestamp.fromDate(new Date(`${dateStr}T00:00:00Z`));
                const endOfDay = Timestamp.fromDate(new Date(`${dateStr}T23:59:59Z`));
                const appointmentsQuery = query(collection(db, "users", OWNER_ID, "appointments"), where('dateTime', '>=', startOfDay), where('dateTime', '<=', endOfDay));
                const querySnapshot = await getDocs(appointmentsQuery);
                
                const bookedIntervals = querySnapshot.docs.map(doc => {
                    const appData = doc.data();
                    const appStart = appData.dateTime.toDate();
                    const serviceForApp = state.services.find(s => s.id === appData.serviceId) || { duration: 30 };
                    const appEnd = new Date(appStart.getTime() + serviceForApp.duration * 60000);
                    return { start: appStart, end: appEnd };
                });

                timeSlotsContainer.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-3 sm:grid-cols-4 gap-2 mt-4";
                let hasAvailableSlots = false;

                allPossibleSlots.forEach(slotStart => {
                    const slotEnd = new Date(slotStart.getTime() + serviceDuration * 60000);
                    let isOverlapping = false;
                    for (const interval of bookedIntervals) {
                        if (slotStart < interval.end && slotEnd > interval.start) {
                            isOverlapping = true;
                            break;
                        }
                    }

                    if (slotStart < new Date()) isOverlapping = true;

                    if (!isOverlapping) {
                        hasAvailableSlots = true;
                        const slotBtn = document.createElement('button');
                        slotBtn.type = "button";
                        slotBtn.textContent = `${String(slotStart.getHours()).padStart(2, '0')}:${String(slotStart.getMinutes()).padStart(2, '0')}`;
                        slotBtn.className = `time-slot border rounded-md py-2 text-sm font-semibold border-slate-300 text-slate-700 hover:opacity-80`;
                        
                        slotBtn.onclick = () => {
                            state.selectedDate = dateStr;
                            state.selectedTime = slotBtn.textContent;
                            document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
                            slotBtn.classList.add('selected');
                            updateSummaryAndShowUserInfo();
                        };
                        grid.appendChild(slotBtn);
                    }
                });

                if (!hasAvailableSlots) {
                    timeSlotsContainer.innerHTML = '<p class="text-slate-500 text-sm text-center mt-4">Nenhum horário disponível para este dia.</p>';
                } else {
                    timeSlotsContainer.appendChild(grid);
                }
            } catch (error) {
                console.error("Erro ao carregar horários:", error);
                timeSlotsContainer.innerHTML = '<p class="text-red-500 text-sm text-center mt-4">Erro ao carregar horários.</p>';
            }
        }function updateSummaryAndShowUserInfo() {
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `<p><strong>Serviço:</strong> ${state.selectedService.name}</p><p><strong>Data:</strong> ${new Date(state.selectedDate + 'T12:00:00').toLocaleDateString('pt-BR')} às ${state.selectedTime}</p><p class="mt-2 font-bold text-lg"><strong>Total:</strong> R$ ${state.selectedService.price.toFixed(2)}</p>`;
            showStep('userinfo');
        }

        async function handleConfirmBooking(e) {
            e.preventDefault();
            const btn = document.getElementById('confirm-booking-btn');
            btn.disabled = true;
            btn.innerHTML = 'Confirmando...';

            try {
                const clientName = document.getElementById('public-client-name').value;
                const clientPhone = document.getElementById('public-client-phone').value;
                const dateTime = new Date(`${state.selectedDate}T${state.selectedTime}`);
                
                const appointmentData = {
                    clientName, clientPhone, 
                    serviceId: state.selectedService.id,
                    serviceName: state.selectedService.name,
                    dateTime: Timestamp.fromDate(dateTime),
                    price: state.selectedService.price,
                    status: 'confirmado',
                    createdAt: Timestamp.now()
                };
                
                await addDoc(collection(db, "users", OWNER_ID, "appointments"), appointmentData);
                
                const confirmationSummaryDiv = document.getElementById('confirmation-summary');
                confirmationSummaryDiv.innerHTML = document.getElementById('summary').innerHTML;
                
                showStep('confirmation');

            } catch (error) {
                console.error("Erro ao confirmar agendamento: ", error);
                alert("Não foi possível confirmar o agendamento. Tente novamente.");
                btn.disabled = false;
                btn.innerHTML = 'Confirmar Agendamento';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('service-select').addEventListener('change', (e) => {
                const selectedId = e.target.value;
                if (selectedId) {
                    state.selectedService = state.services.find(s => s.id === selectedId);
                    document.getElementById('booking-date').value = '';
                    document.getElementById('time-slots-container').innerHTML = '<p class="text-slate-500 text-sm">Selecione uma data para ver os horários disponíveis.</p>';
                    showStep('datetime');
                } else {
                    state.selectedService = null;
                    showStep('service');
                }
            });

            document.getElementById('back-to-step-1').onclick = () => showStep('service');
            document.getElementById('back-to-step-2').onclick = () => showStep('datetime');

            const bookingDateInput = document.getElementById('booking-date'); 
            bookingDateInput.setAttribute('min', new Date().toISOString().split('T')[0]); 
            bookingDateInput.addEventListener('change', (e) => {
                if (state.selectedService) {
                    loadAvailableTimes(e.target.value);
                } else {
                    alert("Por favor, selecione um serviço primeiro.");
                }
            }); 
            document.getElementById('client-info-form').addEventListener('submit', handleConfirmBooking);
        }document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            feather.replace(); 
        });
    </script>
</body>
</html>
